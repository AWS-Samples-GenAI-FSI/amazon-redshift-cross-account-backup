name: Validate Code and Templates

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  basic-validation:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install basic dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml boto3
    
    - name: Validate Python syntax
      run: |
        python -m py_compile scripts/native_snapshot_demo.py
        python -m py_compile scripts/aws_backup_demo.py
        python -m py_compile lambda/aca_redshift_backup_lambda.py
        echo "✅ All Python files have valid syntax"
    
    - name: Validate YAML syntax
      run: |
        python -c "
        import yaml
        import sys
        
        files = [
          'cloudformation/source-account-setup.yaml',
          'cloudformation/target-account-setup.yaml', 
          'cloudformation/aca-lambda-backup-setup.yaml',
          '.github/workflows/validate.yml'
        ]
        
        for file in files:
          try:
            with open(file, 'r') as f:
              yaml.safe_load(f)
            print(f'✅ {file} - Valid YAML')
          except Exception as e:
            print(f'❌ {file} - Invalid YAML: {e}')
            sys.exit(1)
        
        print('✅ All YAML files have valid syntax')
        "
    
    - name: Validate JSON syntax
      run: |
        python -m json.tool config/demo-config.json > /dev/null
        echo "✅ JSON files have valid syntax"
    
    - name: Check file structure
      run: |
        echo "📁 Repository structure:"
        find . -type f -name "*.py" -o -name "*.yaml" -o -name "*.yml" -o -name "*.json" -o -name "*.sh" -o -name "*.md" | head -20
        echo "✅ Repository structure validated"
    
    - name: Validate shell scripts (basic)
      run: |
        for script in *.sh; do
          if [ -f "$script" ]; then
            bash -n "$script" && echo "✅ $script - Valid syntax" || echo "❌ $script - Invalid syntax"
          fi
        done